[uwsgi]

# bind a socker before dropping privileges
shared-socket = :8080

# use http on the shared socker 
http = =0

# increase concurrency
# number of worker processes handling requests
processes = 4

# avoid thundering herd on accept()
thunder-lock = true

# start the master process manager
master = true

# make sure spooler are in the correct directory
spooler-chdir=/app

# start the spooler
spooler = /data/spool

# import the default application in the spooler process to let it find the settings
spooler-import = webapp/wsgi.py

# import the spooler functions in the spooler process
spooler-import = perf/processing.py

# make sure the database is up to date
exec-pre-app = python3 manage.py migrate

# provision the admin user
exec-pre-app = python3 manage.py shell -c "from webapp.provision import provision_admin_user; provision_admin_user()"

# make sure the spool directory exists
exec-pre-app = mkdir -p /data/spool

# make sure the media directory exists
exec-pre-app = mkdir -p /data/media

# start the pq app
module = webapp.wsgi:application

# make sure we shut down when docker asks for it
die-on-term = true

# serve correct mimes
mimefile = /etc/mime.types

# make sure the server fails if the app doesn't work
need-app = true

# serve the static files
static-map = /static=/app/static
static-map = /doc=/app/doc
static-map = /media=/data/media

# set the default page for static directories (used by the doc)
static-index = index.html
